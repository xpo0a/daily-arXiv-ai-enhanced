name: arXiv Daily Flexible Crawler

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 8:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 16:00ï¼‰
    - cron: "0 8 * * *"
  workflow_dispatch:
    inputs:
      start_date:
        description: 'å¼€å§‹æ—¥æœŸ (æ ¼å¼: YYYY-MM-DD æˆ– today/tomorrow/yesterday æˆ– +/-N)'
        required: false
        default: 'today'
        type: string
      end_date:
        description: 'ç»“æŸæ—¥æœŸ (æ ¼å¼: YYYY-MM-DD æˆ– today/tomorrow/yesterday æˆ– +/-N)'
        required: false
        default: 'today'
        type: string
      force_run:
        description: 'å¼ºåˆ¶è¿è¡Œï¼ˆå³ä½¿æ²¡æœ‰æ–°å†…å®¹ï¼‰'
        required: false
        default: false
        type: boolean

jobs:
  crawl:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        uv sync

    - name: Set date variables
      id: date_setup
      run: |
        # è®¾ç½®é»˜è®¤æ—¥æœŸï¼ˆæ‰‹åŠ¨è§¦å‘æ—¶ä½¿ç”¨è¾“å…¥å‚æ•°ï¼Œå®šæ—¶è§¦å‘æ—¶ä½¿ç”¨ä»Šå¤©ï¼‰
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          START_DATE="${{ github.event.inputs.start_date }}"
          END_DATE="${{ github.event.inputs.end_date }}"
        else
          START_DATE="today"
          END_DATE="today"
        fi
        
        # ç”Ÿæˆæ–‡ä»¶å
        if [ "$START_DATE" = "$END_DATE" ]; then
          FILENAME="${START_DATE}.jsonl"
        else
          FILENAME="${START_DATE}_to_${END_DATE}.jsonl"
        fi
        
        echo "start_date=$START_DATE" >> $GITHUB_OUTPUT
        echo "end_date=$END_DATE" >> $GITHUB_OUTPUT
        echo "filename=$FILENAME" >> $GITHUB_OUTPUT
        
        echo "ğŸ“… çˆ¬å–æ—¥æœŸèŒƒå›´: $START_DATE åˆ° $END_DATE"
        echo "ğŸ“„ è¾“å‡ºæ–‡ä»¶å: data/$FILENAME"

    - name: Crawl arXiv papers
      id: crawl_step
      run: |
        source .venv/bin/activate

        START_DATE="${{ steps.date_setup.outputs.start_date }}"
        END_DATE="${{ steps.date_setup.outputs.end_date }}"
        FILENAME="${{ steps.date_setup.outputs.filename }}"

        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ -f "data/${FILENAME}" ]; then
            echo "ğŸ—‘ï¸ å‘ç°æ•°æ®æ–‡ä»¶å·²å­˜åœ¨ï¼Œåˆ é™¤é‡æ–°ç”Ÿæˆ..."
            rm "data/${FILENAME}"
        fi

        cd daily_arxiv
        export OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
        export OPENAI_BASE_URL=${{ secrets.OPENAI_BASE_URL }}
        export LANGUAGE="${{ vars.LANGUAGE }}"
        export KEYWORDS="${{ vars.KEYWORDS }}"
        export MODEL_NAME="${{ vars.MODEL_NAME }}"
        export START_DATE="$START_DATE"
        export END_DATE="$END_DATE"
        export PER_PAGE="${{ vars.PER_PAGE || '200' }}"
        export MAX_PAGES="${{ vars.MAX_PAGES || '10' }}"
        export DATE_FIELD="${{ vars.DATE_FIELD || 'published' }}"

        echo "ğŸ” å¼€å§‹çˆ¬å– arXiv è®ºæ–‡..."
        echo "ğŸ“Š å…³é”®è¯: $KEYWORDS"
        echo "ğŸ“… æ—¥æœŸèŒƒå›´: $START_DATE åˆ° $END_DATE"

        # è°ƒç”¨çµæ´»çˆ¬è™«
        scrapy crawl arxiv_flexible -a start_date="$START_DATE" -a end_date="$END_DATE" -o ../data/${FILENAME}

        if [ ! -f "../data/${FILENAME}" ]; then
            echo "âŒ çˆ¬å–å¤±è´¥ï¼Œæœªç”Ÿæˆæ•°æ®æ–‡ä»¶"
            exit 1
        fi

        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºç©º
        if [ ! -s "../data/${FILENAME}" ]; then
            echo "âš ï¸ çˆ¬å–å®Œæˆä½†æœªæ‰¾åˆ°åŒ¹é…çš„è®ºæ–‡"
            echo "crawl_success=false" >> $GITHUB_OUTPUT
            echo "crawl_filename=${FILENAME}" >> $GITHUB_OUTPUT
            exit 0
        fi

        echo "crawl_success=true" >> $GITHUB_OUTPUT
        echo "crawl_filename=${FILENAME}" >> $GITHUB_OUTPUT
        echo "âœ… çˆ¬å–å®Œæˆ: ${FILENAME}"

    - name: Check for duplicates
      if: steps.crawl_step.outputs.crawl_success == 'true'
      id: dedup_check
      run: |
        source .venv/bin/activate
        echo "æ‰§è¡Œå»é‡æ£€æŸ¥..."

        cd daily_arxiv
        python daily_arxiv/check_stats.py
        dedup_exit_code=$?

        echo "dedup_exit_code=$dedup_exit_code" >> $GITHUB_OUTPUT

        case $dedup_exit_code in
          0)
            echo "has_new_content=true" >> $GITHUB_OUTPUT ;;
          1)
            echo "has_new_content=false" >> $GITHUB_OUTPUT
            echo "skip_reason=no_new_content" >> $GITHUB_OUTPUT ;;
          2)
            echo "has_new_content=false" >> $GITHUB_OUTPUT
            echo "skip_reason=processing_error" >> $GITHUB_OUTPUT
            exit 1 ;;
          *)
            echo "has_new_content=false" >> $GITHUB_OUTPUT
            echo "skip_reason=unknown_error" >> $GITHUB_OUTPUT
            exit 1 ;;
        esac

    - name: AI Enhancement Processing
      if: steps.crawl_step.outputs.crawl_success == 'true' && (steps.dedup_check.outputs.has_new_content == 'true' || github.event.inputs.force_run == 'true')
      run: |
        source .venv/bin/activate
        filename=${{ steps.crawl_step.outputs.crawl_filename }}

        echo "ğŸ¤– å¼€å§‹AIå¢å¼ºå¤„ç†..."
        cd ai
        export OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
        export OPENAI_BASE_URL=${{ secrets.OPENAI_BASE_URL }}
        export LANGUAGE="${{ vars.LANGUAGE }}"
        export MODEL_NAME="${{ vars.MODEL_NAME }}"

        python enhance.py --data ../data/${filename}

        echo "âœ… AIå¢å¼ºå¤„ç†å®Œæˆ"

    - name: Convert to Markdown
      if: steps.crawl_step.outputs.crawl_success == 'true' && (steps.dedup_check.outputs.has_new_content == 'true' || github.event.inputs.force_run == 'true')
      run: |
        source .venv/bin/activate
        filename=${{ steps.crawl_step.outputs.crawl_filename }}
        export LANGUAGE="${{ vars.LANGUAGE }}"

        cd to_md
        AI_FILE="../data/${filename%.*}_AI_enhanced_${LANGUAGE}.jsonl"

        if [ -f "$AI_FILE" ]; then
          echo "ğŸ“ ä½¿ç”¨AIå¢å¼ºæ–‡ä»¶è¿›è¡Œè½¬æ¢..."
          python convert.py --data "$AI_FILE"
        else
          echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°AIå¢å¼ºæ–‡ä»¶"
          exit 1
        fi

    - name: Update file list
      if: steps.crawl_step.outputs.crawl_success == 'true' && (steps.dedup_check.outputs.has_new_content == 'true' || github.event.inputs.force_run == 'true')
      run: |
        echo "ğŸ“‹ æ›´æ–°æ–‡ä»¶åˆ—è¡¨..."
        ls data/*.jsonl | sed 's|data/||' > assets/file-list.txt

    - name: Commit & Push
      if: steps.crawl_step.outputs.crawl_success == 'true' && (steps.dedup_check.outputs.has_new_content == 'true' || github.event.inputs.force_run == 'true')
      run: |
        git config --global user.email "${{ vars.EMAIL }}"
        git config --global user.name "${{ vars.NAME }}"
        git add .
        if git diff --staged --quiet; then
          echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          exit 0
        fi
        
        START_DATE="${{ steps.date_setup.outputs.start_date }}"
        END_DATE="${{ steps.date_setup.outputs.end_date }}"
        
        if [ "$START_DATE" = "$END_DATE" ]; then
          COMMIT_MSG="daily update: $START_DATE arXiv papers"
        else
          COMMIT_MSG="daily update: $START_DATE to $END_DATE arXiv papers"
        fi
        
        git commit -m "$COMMIT_MSG"
        git push origin main

    - name: Summary
      run: |
        if [ "${{ steps.crawl_step.outputs.crawl_success }}" = "true" ]; then
          if [ "${{ steps.dedup_check.outputs.has_new_content }}" = "true" ] || [ "${{ github.event.inputs.force_run }}" = "true" ]; then
            echo "âœ… çˆ¬å–æµç¨‹å®Œæˆï¼ŒåŒ…å«æ–°å†…å®¹"
          else
            echo "â„¹ï¸ çˆ¬å–å®Œæˆä½†æ— æ–°å†…å®¹ï¼Œè·³è¿‡æ›´æ–°"
          fi
        else
          echo "âš ï¸ çˆ¬å–å®Œæˆä½†æœªæ‰¾åˆ°åŒ¹é…çš„è®ºæ–‡"
        fi
