name: arXiv-weekly-ai-enhanced

on:
  schedule:
    # æ¯å‘¨ä¸€æ—©ä¸Š 8:30 UTC è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 16:30ï¼‰
    - cron: "0 0 * * 1"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        uv sync

    - name: Crawl last week's arXiv papers
      id: crawl_step
      run: |
        source .venv/bin/activate

        # è®¡ç®—ä¸Šå‘¨ä¸€åˆ°ä¸Šå‘¨æ—¥çš„æ—¥æœŸèŒƒå›´
        week_start=$(date -u -d "last monday -7 days" "+%Y-%m-%d")
        week_end=$(date -u -d "last sunday" "+%Y-%m-%d")
        filename="week_${week_start}_to_${week_end}.jsonl"

        echo "å¼€å§‹çˆ¬å– ${week_start} è‡³ ${week_end} çš„arXivè®ºæ–‡..."
        echo "è¾“å‡ºæ–‡ä»¶å: data/${filename}"

        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ -f "data/${filename}" ]; then
            echo "ğŸ—‘ï¸ å‘ç°ä¸Šå‘¨æ•°æ®æ–‡ä»¶å·²å­˜åœ¨ï¼Œåˆ é™¤é‡æ–°ç”Ÿæˆ..."
            rm "data/${filename}"
        fi

        cd daily_arxiv
        export OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
        export OPENAI_BASE_URL=${{ secrets.OPENAI_BASE_URL }}
        export LANGUAGE="${{ vars.LANGUAGE }}"
        export KEYWORDS="${{ vars.KEYWORDS }}"
        export MODEL_NAME="${{ vars.MODEL_NAME }}"
        export WEEK_START=$week_start
        export WEEK_END=$week_end

        # è°ƒç”¨ spiderï¼ˆä½ éœ€ç¡®ä¿ spider æ”¯æŒ week å‚æ•°ï¼‰
        scrapy crawl arxiv_weekly -a start_date=$week_start -a end_date=$week_end -o ../data/${filename}

        if [ ! -f "../data/${filename}" ]; then
            echo "âŒ çˆ¬å–å¤±è´¥ï¼Œæœªç”Ÿæˆæ•°æ®æ–‡ä»¶"
            exit 1
        fi

        echo "crawl_filename=${filename}" >> $GITHUB_OUTPUT
        echo "âœ… æ¯å‘¨çˆ¬å–å®Œæˆ: ${filename}"

    - name: Check for duplicates
      id: dedup_check
      run: |
        source .venv/bin/activate
        echo "æ‰§è¡Œå»é‡æ£€æŸ¥..."

        cd daily_arxiv
        python daily_arxiv/check_stats.py
        dedup_exit_code=$?

        echo "dedup_exit_code=$dedup_exit_code" >> $GITHUB_OUTPUT

        case $dedup_exit_code in
          0)
            echo "has_new_content=true" >> $GITHUB_OUTPUT ;;
          1)
            echo "has_new_content=false" >> $GITHUB_OUTPUT
            echo "skip_reason=no_new_content" >> $GITHUB_OUTPUT ;;
          2)
            echo "has_new_content=false" >> $GITHUB_OUTPUT
            echo "skip_reason=processing_error" >> $GITHUB_OUTPUT
            exit 1 ;;
          *)
            echo "has_new_content=false" >> $GITHUB_OUTPUT
            echo "skip_reason=unknown_error" >> $GITHUB_OUTPUT
            exit 1 ;;
        esac

    - name: AI Enhancement Processing
      if: steps.dedup_check.outputs.has_new_content == 'true'
      run: |
        source .venv/bin/activate
        filename=${{ steps.crawl_step.outputs.crawl_filename }}

        echo "å¼€å§‹AIå¢å¼ºå¤„ç†..."
        cd ai
        export OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
        export OPENAI_BASE_URL=${{ secrets.OPENAI_BASE_URL }}
        export LANGUAGE="${{ vars.LANGUAGE }}"
        export MODEL_NAME="${{ vars.MODEL_NAME }}"

        python enhance.py --data ../data/${filename}

        echo "âœ… AIå¢å¼ºå¤„ç†å®Œæˆ"

    - name: Convert to Markdown
      if: steps.dedup_check.outputs.has_new_content == 'true'
      run: |
        source .venv/bin/activate
        filename=${{ steps.crawl_step.outputs.crawl_filename }}
        export LANGUAGE="${{ vars.LANGUAGE }}"

        cd to_md
        AI_FILE="../data/${filename%.*}_AI_enhanced_${LANGUAGE}.jsonl"

        if [ -f "$AI_FILE" ]; then
          echo "ä½¿ç”¨AIå¢å¼ºæ–‡ä»¶è¿›è¡Œè½¬æ¢..."
          python convert.py --data "$AI_FILE"
        else
          echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°AIå¢å¼ºæ–‡ä»¶"
          exit 1
        fi

    - name: Update file list
      if: steps.dedup_check.outputs.has_new_content == 'true'
      run: |
        echo "æ›´æ–°æ–‡ä»¶åˆ—è¡¨..."
        ls data/*.jsonl | sed 's|data/||' > assets/file-list.txt

    - name: Commit & Push
      if: steps.dedup_check.outputs.has_new_content == 'true'
      run: |
        git config --global user.email "${{ vars.EMAIL }}"
        git config --global user.name "${{ vars.NAME }}"
        git add .
        if git diff --staged --quiet; then
          echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          exit 0
        fi
        git commit -m "weekly update: $(date -u '+%Y-%m-%d') arXiv papers"
        git push origin main

    - name: Summary
      run: |
        if [ "${{ steps.dedup_check.outputs.has_new_content }}" = "true" ]; then
          echo "âœ… æ¯å‘¨çˆ¬å–æµç¨‹å®Œæˆï¼ŒåŒ…å«æ–°å†…å®¹"
        else
          echo "â„¹ï¸ æœ¬å‘¨æ— æ–°å†…å®¹ï¼Œè·³è¿‡æ›´æ–°"
        fi
